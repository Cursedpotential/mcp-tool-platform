version: '3.8'

# ============================================================================
# VPS1 - Storage & Database Backend (Hetzner 8c/16GB + 50GB block storage)
# ============================================================================
#
# Services:
# - PostgreSQL (main database on 50GB block storage)
# - FerretDB (MongoDB compatibility layer)
# - Directus (headless CMS with AI extensions)
# - PhotoPrism (media management with AI analysis)
# - n8n (workflow automation)
# - Tailscale + rclone sidecar (VPN + R2 backup)
#
# Storage strategy:
# - 50GB block storage: PostgreSQL + shared media files
# - R2: Nightly backups only
# - AWS S3 free tier: LiteLLM cache (on VPS2)
#
# Deploy: docker-compose -f docker-compose.vps1-storage.yml up -d
#
# ============================================================================

networks:
  salem-network:
    driver: bridge
  traefik:
    external: true

volumes:
  # Block storage mount (50GB)
  block_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/block-storage
  # Persistent volumes (all mapped to block storage)
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/block-storage/postgres
  ferretdb_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/block-storage/ferretdb
  n8n_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/block-storage/n8n
  # Shared media directory (accessible to all services)
  media_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/block-storage/media

services:
  # ============================================================================
  # PostgreSQL - Main Database
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: salem-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-salem}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - salem-network
      - traefik
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.postgres.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.postgres.entrypoints=postgres"
      - "traefik.tcp.services.postgres.loadbalancer.server.port=5432"
      - "coolify.managed=true"
      - "coolify.type=database"

  # ============================================================================
  # FerretDB - MongoDB Compatibility Layer
  # ============================================================================
  ferretdb:
    image: ghcr.io/ferretdb/ferretdb:latest
    container_name: salem-ferretdb
    environment:
      - FERRETDB_POSTGRESQL_URL=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-salem}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - salem-network
      - traefik
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.ferretdb.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.ferretdb.entrypoints=mongodb"
      - "traefik.tcp.services.ferretdb.loadbalancer.server.port=27017"
      - "coolify.managed=true"
      - "coolify.type=database"

  # ============================================================================
  # Directus - Headless CMS
  # ============================================================================
  directus:
    image: directus/directus:latest
    container_name: salem-directus
    environment:
      - DB_CLIENT=pg
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=${POSTGRES_DB:-salem}
      - DB_USER=${POSTGRES_USER:-postgres}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - ADMIN_EMAIL=${DIRECTUS_ADMIN_EMAIL}
      - ADMIN_PASSWORD=${DIRECTUS_ADMIN_PASSWORD}
      - KEY=${DIRECTUS_KEY}
      - SECRET=${DIRECTUS_SECRET}
      - STORAGE_LOCATIONS=local
      - STORAGE_LOCAL_ROOT=/directus/uploads
      - PUBLIC_URL=https://cms.${DOMAIN}
      - MAX_PAYLOAD_SIZE=100mb
      - CACHE_ENABLED=false
      - WEBSOCKETS_ENABLED=true
    volumes:
      - media_storage:/directus/uploads
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - salem-network
      - traefik
    deploy:
      resources:
        limits:
          memory: 2G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.directus.rule=Host(`cms.${DOMAIN}`)"
      - "traefik.http.routers.directus.entrypoints=websecure"
      - "traefik.http.routers.directus.tls.certresolver=letsencrypt"
      - "traefik.http.services.directus.loadbalancer.server.port=8055"
      - "coolify.managed=true"
      - "coolify.type=application"

  # ============================================================================
  # PhotoPrism - Media Management with AI
  # ============================================================================
  photoprism:
    image: photoprism/photoprism:latest
    container_name: salem-photoprism
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    environment:
      - PHOTOPRISM_ADMIN_USER=${PHOTOPRISM_ADMIN_USER:-admin}
      - PHOTOPRISM_ADMIN_PASSWORD=${PHOTOPRISM_ADMIN_PASSWORD}
      - PHOTOPRISM_AUTH_MODE=password
      - PHOTOPRISM_SITE_URL=https://photos.${DOMAIN}
      - PHOTOPRISM_DATABASE_DRIVER=postgres
      - PHOTOPRISM_DATABASE_SERVER=postgres:5432
      - PHOTOPRISM_DATABASE_NAME=${POSTGRES_DB:-salem}
      - PHOTOPRISM_DATABASE_USER=${POSTGRES_USER:-postgres}
      - PHOTOPRISM_DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - PHOTOPRISM_DISABLE_CHOWN=false
      - PHOTOPRISM_DISABLE_WEBDAV=false
      - PHOTOPRISM_DETECT_NSFW=true
      - PHOTOPRISM_UPLOAD_NSFW=false
      - PHOTOPRISM_EXPERIMENTAL=true
      - PHOTOPRISM_HTTP_COMPRESSION=gzip
    working_dir: /photoprism
    volumes:
      - media_storage:/photoprism/originals
      - block_storage:/photoprism/storage
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - salem-network
      - traefik
    deploy:
      resources:
        limits:
          memory: 4G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.photoprism.rule=Host(`photos.${DOMAIN}`)"
      - "traefik.http.routers.photoprism.entrypoints=websecure"
      - "traefik.http.routers.photoprism.tls.certresolver=letsencrypt"
      - "traefik.http.services.photoprism.loadbalancer.server.port=2342"
      - "coolify.managed=true"
      - "coolify.type=application"

  # ============================================================================
  # n8n - Workflow Automation
  # ============================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: salem-n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=n8n.${DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.${DOMAIN}/
      - GENERIC_TIMEZONE=America/New_York
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-salem}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-postgres}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - n8n_data:/home/node/.n8n
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - media_storage:/media
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - salem-network
      - traefik
    deploy:
      resources:
        limits:
          memory: 2G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.${DOMAIN}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "coolify.managed=true"
      - "coolify.type=application"
