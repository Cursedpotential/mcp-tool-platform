version: '3.8'

services:
  # ============================================================================
  # Neo4j - Graph database for entity relationships (Graphiti)
  # ============================================================================
  neo4j:
    image: neo4j:5.15-community
    container_name: salem-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Chroma VPS - Persistent vector database for long-term context
  # ============================================================================
  chroma:
    image: chromadb/chroma:latest
    container_name: salem-chroma
    ports:
      - "8000:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_AUTH_CREDENTIALS_PROVIDER=chromadb.auth.token.TokenConfigServerAuthCredentialsProvider
      - CHROMA_SERVER_AUTH_TOKEN_TRANSPORT_HEADER=X-Chroma-Token
      - CHROMA_SERVER_AUTH_CREDENTIALS=${CHROMA_AUTH_TOKEN}
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Directus - Headless CMS with R2 storage backend
  # ============================================================================
  directus:
    image: directus/directus:latest
    container_name: salem-directus
    ports:
      - "8055:8055"
    environment:
      - DB_CLIENT=pg
      - DB_HOST=${SUPABASE_HOST}
      - DB_PORT=5432
      - DB_DATABASE=${SUPABASE_DATABASE}
      - DB_USER=${SUPABASE_USER}
      - DB_PASSWORD=${SUPABASE_PASSWORD}
      - DB_SSL=true
      - ADMIN_EMAIL=${DIRECTUS_ADMIN_EMAIL}
      - ADMIN_PASSWORD=${DIRECTUS_ADMIN_PASSWORD}
      - KEY=${DIRECTUS_KEY}
      - SECRET=${DIRECTUS_SECRET}
      - STORAGE_LOCATIONS=r2
      - STORAGE_R2_DRIVER=s3
      - STORAGE_R2_KEY=${R2_ACCESS_KEY_ID}
      - STORAGE_R2_SECRET=${R2_SECRET_ACCESS_KEY}
      - STORAGE_R2_BUCKET=${R2_BUCKET}
      - STORAGE_R2_REGION=auto
      - STORAGE_R2_ENDPOINT=${R2_ENDPOINT}
      - STORAGE_R2_ACL=private
      - PUBLIC_URL=${DIRECTUS_PUBLIC_URL}
      - MAX_PAYLOAD_SIZE=100mb
      - CACHE_ENABLED=true
      - CACHE_STORE=redis
      - REDIS=redis://:${REDIS_PASSWORD}@redis:6379
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # PhotoPrism - AI-powered photo management with R2 storage
  # ============================================================================
  photoprism:
    image: photoprism/photoprism:latest
    container_name: salem-photoprism
    ports:
      - "2342:2342"
    environment:
      - PHOTOPRISM_SITE_URL=http://localhost:2342
      - PHOTOPRISM_SITE_TITLE=Salem Forensics - Evidence Photos
      - PHOTOPRISM_SITE_CAPTION=Forensic Image Analysis
      - PHOTOPRISM_ADMIN_USER=${PHOTOPRISM_ADMIN_USER}
      - PHOTOPRISM_ADMIN_PASSWORD=${PHOTOPRISM_ADMIN_PASSWORD}
      - PHOTOPRISM_DATABASE_DRIVER=postgres
      - PHOTOPRISM_DATABASE_DSN=postgres://${SUPABASE_USER}:${SUPABASE_PASSWORD}@${SUPABASE_HOST}:5432/${SUPABASE_DATABASE}?sslmode=require
      - PHOTOPRISM_ORIGINALS_PATH=/photoprism/originals
      - PHOTOPRISM_STORAGE_PATH=/photoprism/storage
      - PHOTOPRISM_IMPORT_PATH=/photoprism/import
      - PHOTOPRISM_BACKUP_PATH=/photoprism/backup
      - PHOTOPRISM_BACKUP_SCHEDULE=0 2 * * *
      - PHOTOPRISM_DISABLE_WEBDAV=false
      - PHOTOPRISM_DISABLE_SETTINGS=false
      - PHOTOPRISM_DISABLE_TENSORFLOW=false
      - PHOTOPRISM_DETECT_NSFW=true
      - PHOTOPRISM_UPLOAD_NSFW=false
      - PHOTOPRISM_WORKERS=2
      - PHOTOPRISM_WAKEUP_INTERVAL=900
      - PHOTOPRISM_LOG_LEVEL=info
      - PHOTOPRISM_DEBUG=false
    volumes:
      - photoprism_originals:/photoprism/originals
      - photoprism_storage:/photoprism/storage
      - photoprism_import:/photoprism/import
      - photoprism_backup:/photoprism/backup
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Redis - Caching, rate limiting, job queues
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: salem-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # R2 Sync Service - Syncs PhotoPrism originals to R2
  # ============================================================================
  r2-sync:
    image: rclone/rclone:latest
    container_name: salem-r2-sync
    environment:
      - RCLONE_CONFIG_R2_TYPE=s3
      - RCLONE_CONFIG_R2_PROVIDER=Cloudflare
      - RCLONE_CONFIG_R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - RCLONE_CONFIG_R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - RCLONE_CONFIG_R2_ENDPOINT=${R2_ENDPOINT}
      - RCLONE_CONFIG_R2_ACL=private
    volumes:
      - photoprism_originals:/source:ro
    command: >
      sync /source r2:${R2_BUCKET}/photoprism
      --transfers 4
      --checkers 8
      --contimeout 60s
      --timeout 300s
      --retries 3
      --low-level-retries 10
      --stats 1m
      --stats-file-name-length 0
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Kasm Workspace - Debian desktop with VNC (persistent backdoor access)
  # ============================================================================
  kasm-workspace:
    image: kasmweb/debian-bookworm-desktop:1.15.0
    container_name: salem-kasm-workspace
    ports:
      - "6901:6901"  # VNC web interface
    environment:
      - VNC_PW=${KASM_VNC_PASSWORD}
      - VNC_RESOLUTION=1920x1080
      - VNC_COL_DEPTH=24
    volumes:
      - kasm_home:/home/kasm-user
      - kasm_config:/home/kasm-user/.config
      - ./scripts:/scripts:ro
      - ./data:/data
    shm_size: 2gb
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Advanced Tooling Container - Python, Node.js, CLI tools
  # ============================================================================
  tooling:
    build:
      context: .
      dockerfile: Dockerfile.tooling
    container_name: salem-tooling
    environment:
      - SUPABASE_URL=https://${SUPABASE_HOST}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - NEO4J_URL=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_BUCKET=${R2_BUCKET}
    volumes:
      - ./server/python-tools:/app/python-tools
      - ./data:/data
      - tooling_cache:/root/.cache
    working_dir: /app
    command: tail -f /dev/null  # Keep container running
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Tailscale - Secure VPN for remote access
  # ============================================================================
  tailscale:
    image: tailscale/tailscale:latest
    container_name: salem-tailscale
    hostname: salem-forensics
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=--advertise-tags=tag:salem
    volumes:
      - tailscale_data:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: unless-stopped
    network_mode: host

  # ============================================================================
  # Jupyter Lab - Interactive Python notebooks for analysis
  # ============================================================================
  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: salem-jupyter
    ports:
      - "8888:8888"
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=${JUPYTER_TOKEN}
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/data
      - jupyter_config:/home/jovyan/.jupyter
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # n8n - Workflow automation (alternative to Zapier)
  # ============================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: salem-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=America/New_York
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Metabase - Business intelligence and analytics
  # ============================================================================
  metabase:
    image: metabase/metabase:latest
    container_name: salem-metabase
    ports:
      - "3001:3000"
    environment:
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=${SUPABASE_DATABASE}
      - MB_DB_PORT=5432
      - MB_DB_USER=${SUPABASE_USER}
      - MB_DB_PASS=${SUPABASE_PASSWORD}
      - MB_DB_HOST=${SUPABASE_HOST}
    volumes:
      - metabase_data:/metabase-data
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # LibreChat - Multi-model chat interface (ChatGPT UI alternative)
  # ============================================================================
  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: salem-librechat
    ports:
      - "3002:3080"
    environment:
      - HOST=0.0.0.0
      - PORT=3080
      - MONGO_URI=mongodb://mongo:27017/LibreChat
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Anthropic
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Google
      - GOOGLE_API_KEY=${GEMINI_API_KEY}
      # OpenRouter (multi-model)
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      # Cohere
      - COHERE_API_KEY=${COHERE_API_KEY}
      # Azure OpenAI
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      # Custom endpoint (for local models)
      - CUSTOM_API_KEY=${CUSTOM_API_KEY}
      - CUSTOM_BASE_URL=${CUSTOM_BASE_URL}
    depends_on:
      - mongo
      - meilisearch
    restart: unless-stopped
    networks:
      - salem-network

  # MongoDB for LibreChat
  mongo:
    image: mongo:7
    container_name: salem-mongo
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped
    networks:
      - salem-network

  # MeiliSearch for LibreChat
  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: salem-meilisearch
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
    volumes:
      - meilisearch_data:/meili_data
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Open WebUI - ChatGPT-style UI for local/remote LLMs
  # ============================================================================
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: salem-open-webui
    ports:
      - "3003:8080"
    environment:
      - WEBUI_SECRET_KEY=${OPENWEBUI_SECRET_KEY}
      - WEBUI_NAME=Salem Forensics AI
      # OpenAI API
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE_URL=https://api.openai.com/v1
      # Ollama (for local models)
      - OLLAMA_BASE_URL=http://ollama:11434
      # Enable features
      - ENABLE_RAG=true
      - ENABLE_SIGNUP=false
      - DEFAULT_USER_ROLE=user
    volumes:
      - open_webui_data:/app/backend/data
    depends_on:
      - ollama
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Ollama - Local LLM runtime (Llama 3, Mistral, etc.)
  # ============================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: salem-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - salem-network
    # Uncomment if you have GPU
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # ============================================================================
  # Browserless - Headless Chrome for web scraping, PDFs, screenshots
  # ============================================================================
  browserless:
    image: browserless/chrome:latest
    container_name: salem-browserless
    ports:
      - "3004:3000"
    environment:
      - TOKEN=${BROWSERLESS_TOKEN}
      - MAX_CONCURRENT_SESSIONS=5
      - CONNECTION_TIMEOUT=60000
      - MAX_QUEUE_LENGTH=10
      - ENABLE_DEBUGGER=true
      - PREBOOT_CHROME=true
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # Playwright - Headless browser automation (alternative to Browserless)
  # ============================================================================
  playwright:
    build:
      context: .
      dockerfile: Dockerfile.playwright
    container_name: salem-playwright
    ports:
      - "3005:3000"
    environment:
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    volumes:
      - playwright_cache:/ms-playwright
      - ./scripts/playwright:/scripts
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # LiteLLM - Universal LLM proxy/gateway (100+ models, unified API)
  # ============================================================================
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: salem-litellm
    ports:
      - "4000:4000"
    environment:
      # Database for cost tracking
      - DATABASE_URL=postgresql://${SUPABASE_USER}:${SUPABASE_PASSWORD}@${SUPABASE_HOST}:5432/${SUPABASE_DATABASE}?sslmode=require
      # Master key for authentication
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
      # Enable features
      - LITELLM_LOG=INFO
      - LITELLM_DROP_PARAMS=true
      # Redis for caching
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # Model API keys (LiteLLM will route based on model prefix)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}
      - AZURE_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_API_BASE=${AZURE_OPENAI_ENDPOINT}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - TOGETHER_API_KEY=${TOGETHER_API_KEY}
      - REPLICATE_API_KEY=${REPLICATE_API_KEY}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
    volumes:
      - ./litellm_config.yaml:/app/config.yaml
    command: --config /app/config.yaml --port 4000 --num_workers 4
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - salem-network

  # ============================================================================
  # MetaMCP - MCP server registry and discovery service
  # ============================================================================
  metamcp:
    build:
      context: .
      dockerfile: Dockerfile.metamcp
    container_name: salem-metamcp
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - DATABASE_URL=postgresql://${SUPABASE_USER}:${SUPABASE_PASSWORD}@${SUPABASE_HOST}:5432/${SUPABASE_DATABASE}?sslmode=require
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - MCP_REGISTRY_URL=https://mcp.run/registry
    volumes:
      - ./server/mcp:/app/mcp
      - metamcp_data:/app/data
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - salem-network

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
  chroma_data:
  photoprism_originals:
  photoprism_storage:
  photoprism_import:
  photoprism_backup:
  redis_data:
  kasm_home:
  kasm_config:
  tooling_cache:
  tailscale_data:
  jupyter_config:
  n8n_data:
  metabase_data:
  mongo_data:
  meilisearch_data:
  open_webui_data:
  ollama_data:
  playwright_cache:
  metamcp_data:

networks:
  salem-network:
    driver: bridge
