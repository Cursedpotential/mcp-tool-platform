FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Build tools
    build-essential \
    git \
    curl \
    wget \
    # Node.js
    nodejs \
    npm \
    # Database clients
    postgresql-client \
    redis-tools \
    # Network tools
    netcat-openbsd \
    iputils-ping \
    dnsutils \
    # Text processing
    jq \
    yq \
    ripgrep \
    fd-find \
    # Archive tools
    unzip \
    zip \
    tar \
    # PDF tools
    poppler-utils \
    # Image tools
    imagemagick \
    # OCR
    tesseract-ocr \
    tesseract-ocr-eng \
    # Other
    vim \
    nano \
    htop \
    tmux \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 (LTS)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm
RUN npm install -g pnpm

# Install Python packages
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# Install additional Python tools
RUN pip install --no-cache-dir \
    # NLP
    spacy \
    nltk \
    textblob \
    sentence-transformers \
    # LLM frameworks
    langchain \
    langgraph \
    llama-index \
    # Graph databases
    neo4j \
    graphiti-core \
    # Vector databases
    chromadb \
    qdrant-client \
    # Document processing
    unstructured \
    pypdf \
    python-docx \
    openpyxl \
    # Data science
    pandas \
    numpy \
    scipy \
    scikit-learn \
    # Visualization
    matplotlib \
    seaborn \
    plotly \
    # Database
    psycopg2-binary \
    sqlalchemy \
    # Storage
    boto3 \
    # Utilities
    python-dotenv \
    pydantic \
    httpx \
    aiohttp \
    beautifulsoup4 \
    lxml

# Download spaCy models
RUN python -m spacy download en_core_web_sm \
    && python -m spacy download en_core_web_md

# Download NLTK data
RUN python -c "import nltk; nltk.download('vader_lexicon'); nltk.download('punkt'); nltk.download('stopwords')"

# Download TextBlob corpora
RUN python -m textblob.download_corpora

# Install CLI tools
RUN pip install --no-cache-dir \
    # AWS CLI
    awscli \
    # Supabase CLI (via npm)
    && npm install -g supabase \
    # Neo4j CLI
    && npm install -g @neo4j/cli \
    # Directus CLI
    && npm install -g @directus/cli

# Create app directory
WORKDIR /app

# Create data directory
RUN mkdir -p /data

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Keep container running
CMD ["tail", "-f", "/dev/null"]
